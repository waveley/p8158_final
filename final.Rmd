---
title: "P8158 Final"
author: "Waveley Qiu (wq2162)"
date: "2022-04-14"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
<<<<<<< HEAD
<<<<<<< HEAD
=======
<<<<<<< HEAD

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(haven)
library(lavaan)
library(psych)
library(GPArotation)
library(naniar)
library(gtsummary)
```

```{r}
dataset <- readxl::read_excel("data/Athlete_Non-Athlete MH Survey - ALL DATA.xlsx", 
                              sheet = "athlete_fin") %>% 
  slice(-1) %>%   
  replace_with_na_all(condition = ~.x == "999") %>%
  janitor::clean_names()

dataset_no_na <- dataset %>% 
  select(-c("shield_dts", "date")) %>% 
  na.omit()

athletes <- dataset %>% filter(athlete_yn == "1") %>% select(-c("shield_dts", "date"))
athletes %>% colnames()

athletes_no_na <- athletes %>% na.omit()

non_athletes <- dataset %>% filter(athlete_yn == "2")
```

## Adding COVID-19 Quarantine Weeks & Sport Hours Measures

0 to 7 weeks in quarantine ("s)

```{r}
table(athletes$bub_size %>% as.numeric())
hist(athletes$play_hrs %>% as.numeric())

athletes <-
  athletes %>% 
  mutate(
    weeks_cat = weeks_sd %>% as.factor(),
    bubble_cat = bub_size %>% as.numeric(),
    play_hrs = play_hrs %>% as.numeric(),
    play_hrs_cat = case_when(
      play_hrs < 5 ~ "less than 5 hrs",
      5 <= play_hrs & play_hrs < 10 ~ "between 5 and 10 hrs",
      10 <= play_hrs & play_hrs < 15 ~ "between 10 and 15 hrs",
      15 <= play_hrs & play_hrs < 20 ~ "between 15 and 20 hrs",
      20 <= play_hrs & play_hrs < 25 ~ "between 20 and 25 hrs",
      25 <= play_hrs & play_hrs < 30 ~ "between 25 and 30 hrs",
      30 <= play_hrs ~ "30 or more hours"
    )
)
```

<<<<<<< HEAD
=======
## Interested Variables

```{r}
=======
```{r setup, include=FALSE}
>>>>>>> d3437852f23db65dbc0a64b6b205716ccef9448e
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE)
library(sem)
library(semPlot)
source("shared_code/data_prep_and_setup.R")
```
>>>>>>> 2c66653fdc9b5cbb785f31e2c6d13f31b147498d

## Construct Reliability: Dedication to Sport/ athlete identity

```{r}
athletic_identity <- c("cnsdr_ath", "sprt_goals", "frnds_ath", "sprt_impt", "think_sprt", "bad_sprt", "dprs_sprt")
```
Chronbach's alpha is 0.74, with a 95 \% confidence interval of (0.70, 0.78).

# EFA & CFA of athlete identity scale
```{r}
#parallel analysis
athlete_parallel = fa.parallel(selected_features, cor = "poly", fa = "pc")
athlete_parallel$pc.values

# 2 factor
athlete_2factor = fa(r=selected_features, nfactors = 2, cor = "poly")
fa.diagram(athlete_2factor, digits = 2, simple = TRUE)

# 3 factor
athlete_3factor = fa(r=selected_features, nfactors = 3, cor = "poly")
fa.diagram(athlete_3factor, digits = 2, simple = TRUE)

# 2 factor CFA
athlete_2model <- 'A =~ sprt_goals + cnsdr_ath + frnds_ath + sprt_impt + think_sprt
                  B =~ dprs_sprt + bad_sprt'

athlete_2CFA = cfa(athlete_2model, data = selected_features,
                   ordered = names(selected_features),
                   std.lv = TRUE)
summary(athlete_2CFA, fit.measures = TRUE)

# 3 factor CFA
athlete_3model <- 'social_identity =~ sprt_goals + cnsdr_ath + frnds_ath 
                   exclusive = ~ sprt_impt + think_sprt
                   negative_affectivity =~ dprs_sprt + bad_sprt
                   athletic_identity =~social_identity + exclusive + negative_affectivity '

athlete_3CFA = cfa(athlete_3model, data = athletic_identity_matrix,
                   ordered = names(athletic_identity_matrix),
                   std.lv = TRUE)
summary(athlete_3CFA, fit.measures = TRUE)


```
Reject the 2 factor model and 3 factor model fits the data well.

## Construct Reliability: Resilience
```{r}
resilience <- c("bounce", "strs_evnt", "strs_rcvr", "snap_back","difficult","setbacks")

total_resilience <- athletes[, resilience] %>% map_df(., as.numeric)
total_alpha <-  psych::alpha(positive_resilience %>% as.matrix())
positive_alpha

resilience_positive <- c("bounce", "strs_rcvr","difficult")

positive_resilience <- athletes[, resilience_positive] %>% map_df(., as.numeric)
positive_alpha <-  psych::alpha(positive_resilience %>% as.matrix())
positive_alpha

resilience_negative <- c("strs_evnt", "snap_back","setbacks")
negative_resilience <- athletes[, resilience_negative] %>% map_df(., as.numeric)
negative_alpha <-  psych::alpha(negative_resilience %>% as.matrix())
negative_alpha

# 1 factor CFA
resilience_1factor <- 'resilience=~ bounce + strs_evnt + strs_rcvr + snap_back + difficult + setbacks'

resilience_1CFA = cfa(resilience_1factor, data = total_resilience,
                   ordered = names(total_resilience),
                   std.lv = TRUE)
summary(resilience_1CFA, fit.measures = TRUE)
```

Chronbach's alpha is 0.89, with a 95 \% confidence interval of (0.87, 0.90).

## Construct Reliability: wellbeing (measured by The Adult Mental Health Continuum 14 items)
```{r}
#wellbeing <- c("happy", "strs_evnt", "strs_rcvr", "snap_back","difficult","setbacks")
selected_wellbeing <- athletes[, 28:41] %>% map_df(., as.numeric)
wellbeing_alpha <-  psych::alpha(selected_wellbeing %>% as.matrix())
wellbeing_alpha
```

Chronbach's alpha is 0.91, with a 95 \% confidence interval of (0.90, 0.91).

## Latent Variables

LV1:dedication_to_sport
CNSDR_ATH: I consider myself an athlete
SPRT_GOALS: I have many goals related to sport
FRNDS_ATH: Most of my friends are athlete
SPRT_IMPT: Sport is the most important part of my life
THINK_SPRT: I spend more time thinking about sport than anything else
SPRT_LVL: Sport level

LV2:positive_outlook
HAPPY: Happy
INT_LIFE: Interested in life
SATISFIED: Satisfied
CONT_SOC: That you had something important to contribute to society

LV3:interaction_society
BELONG: That you belonged to a community (like a social group or neighbourhood)
BET_SOC: That our society is becoming a better place for people like you
PEOPLE_GOOD: That people are basically good
SENSE_SOC: That the way our society works makes sense to you

LV4: maturity
LIKE_PER: That you liked most parts of your personality
RESPONSIBLE: Good at managing the responsibilities of your daily life
WARM_REL: That you had warm and trusting relationships with others
CHAL_EXP: That you had experiences that challenged you to grow and become a better person
EXP_IDEA: Confident to think or express your own ideas and opinions
MEANING: That your life has a sense of direction or meaning to it

LV5: resilience
BOUNCE: I ten-d to bounce back quickly after hard times
STRS_EVNT: I have a hard time making it through stressful events
STRS_RCVR: It does not take me long to recover from a stressful event
SNAP_BACK: It is hard for me to snap back when something bad happens
DIFFICULT: I usually come through difficult times with little trouble
SETBACKS: I tend to take a long time to get over setbacks in my life

```{r}
 athlete_sem2 <- '
  # measurement model
    external_identity =~ sprt_goals + cnsdr_ath + frnds_ath
    internal_value =~ sprt_impt + think_sprt
    negative_events =~ dprs_sprt + bad_sprt
    
    athlete_identity =~ external_identity + internal_value + negative_events
    
    healthy_lifestyle =~ hr_sleep + smoking + fruit_veg
    
    resilience =~ bounce + strs_evnt + strs_rcvr + snap_back + difficult + setbacks
    
  # structural model - direct effects
    mhc_sf ~ a*athlete_identity + b*healthy_lifestyle + c*resilience
    resilience ~ d*athlete_identity
    healthy_lifestyle ~ e*athlete_identity

  # indirect
    indirect_athlete_identity := d*c + e*b

  # total
    total_athlete_identity:= d*c + a + e*b
'

athlete_sem_fit2 <- sem(athlete_sem2, 
                       data = athletes, 
                       sample.cov = TRUE, 
                       missing = "ML")
summary(athlete_sem_fit2)

semPaths(athlete_sem_fit2,
         what = "paths",
         whatLabels = "std", 
         reorder = FALSE,
         layout = "tree2",
         rotation = 2,
         intercepts = FALSE)
```

## Boxplot of MHC_SF between athlete and non-athlete
```{r}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_classic() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "brewer",
  ggplot2.continuous.fill = "brewer"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# MHC_SF
MHC_SF <- c("mhc_sf", "athlete_yn")

MHC_SF_numeric <- dataset[,MHC_SF] %>% mutate(
  mhc_sf= as.numeric(mhc_sf),
  athlete_yn = as.factor( athlete_yn))

ggplot(data =MHC_SF_numeric, aes(y = mhc_sf, x = athlete_yn), group = athlete_yn) + geom_boxplot(aes(color = athlete_yn)) +
  labs(title = "MHC_SF of Athletes and Non-athletes",
       y = "Total MHC Score",
       x = " ") +
  scale_x_discrete(
    labels = c("Athletes", "Non-athletes")
  )  + theme_bw() + 
  theme(legend.position = "bottom")


# Resilience
resilience <- c( "athlete_yn","bounce", "strs_evnt", "strs_rcvr", "snap_back", "difficult", "setbacks")

resilience_numeric <- dataset[,resilience] %>% map_df(., as.numeric)

resilience_matrix <- resilience_numeric %>% as.matrix()

ath_resilience_numeric = resilience_numeric %>% mutate(
  total_resilience_score = bounce + strs_evnt + strs_rcvr + snap_back + difficult + setbacks,
  athlete_yn= as.factor(athlete_yn)
)

ggplot(data = ath_resilience_numeric, aes(x = athlete_yn, y = total_resilience_score) )+
  geom_boxplot(aes(color = athlete_yn))+
  labs(title = "Total Resilience Score of Athletes and Non-athletes",
      y = "Total Resilience Score",
      x = " ") +
  scale_x_discrete(
    labels = c("Athletes", "Non-athletes"))  + theme_bw() + 
  theme(legend.position = "bottom")

gtsummary::tbl_summary(ath_resilience_numeric %>% select(athlete_yn, total_resilience_score), by = athlete_yn) %>% add_p()
```


