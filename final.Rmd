---
title: "P8158 Final"
author: "Waveley Qiu (wq2162)"
date: "2022-04-14"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
<<<<<<< HEAD

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(haven)
library(lavaan)
library(psych)
library(GPArotation)
library(naniar)
library(gtsummary)
```

```{r}
dataset <- readxl::read_excel("data/Athlete_Non-Athlete MH Survey - ALL DATA.xlsx", 
                              sheet = "athlete_fin") %>% 
  slice(-1) %>%   
  replace_with_na_all(condition = ~.x == "999") %>%
  janitor::clean_names()

dataset_no_na <- dataset %>% 
  select(-c("shield_dts", "date")) %>% 
  na.omit()

athletes <- dataset %>% filter(athlete_yn == "1") %>% select(-c("shield_dts", "date"))
athletes %>% colnames()

athletes_no_na <- athletes %>% na.omit()

non_athletes <- dataset %>% filter(athlete_yn == "2")
```

## Adding COVID-19 Quarantine Weeks & Sport Hours Measures

0 to 7 weeks in quarantine ("s)

```{r}
table(athletes$bub_size %>% as.numeric())
hist(athletes$play_hrs %>% as.numeric())

athletes <-
  athletes %>% 
  mutate(
    weeks_cat = weeks_sd %>% as.factor(),
    bubble_cat = bub_size %>% as.numeric(),
    play_hrs = play_hrs %>% as.numeric(),
    play_hrs_cat = case_when(
      play_hrs < 5 ~ "less than 5 hrs",
      5 <= play_hrs & play_hrs < 10 ~ "between 5 and 10 hrs",
      10 <= play_hrs & play_hrs < 15 ~ "between 10 and 15 hrs",
      15 <= play_hrs & play_hrs < 20 ~ "between 15 and 20 hrs",
      20 <= play_hrs & play_hrs < 25 ~ "between 20 and 25 hrs",
      25 <= play_hrs & play_hrs < 30 ~ "between 25 and 30 hrs",
      30 <= play_hrs ~ "30 or more hours"
    )
)
```

## Interested Variables

=======
>>>>>>> 162c4cc18082cc8c44bdff6a5dd06a1a4a1b644a
```{r}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE)
library(sem)
library(semPlot)
source("shared_code/data_prep_and_setup.R")
```

## Construct Reliability: Dedication to Sport/ athlete identity

```{r}
athletic_identity <- c("cnsdr_ath", "sprt_goals", "frnds_ath", "sprt_impt", "think_sprt", "bad_sprt", "dprs_sprt")

athletic_identity_numeric <- athletes[,athletic_identity] %>% map_df(., as.numeric)

athletic_identity_matrix <- athletic_identity_numeric %>% as.matrix()

athlete_alpha <- psych::alpha(athletic_identity_matrix)
athlete_alpha

```
Chronbach's alpha is 0.74, with a 95 \% confidence interval of (0.70, 0.78).

# EFA & CFA of athlete identity scale
```{r}
#parallel analysis
athlete_parallel = fa.parallel(selected_features, cor = "poly", fa = "pc")
athlete_parallel$pc.values

# 2 factor
athlete_2factor = fa(r=selected_features, nfactors = 2, cor = "poly")
fa.diagram(athlete_2factor, digits = 2, simple = TRUE)

# 3 factor
athlete_3factor = fa(r=selected_features, nfactors = 3, cor = "poly")
fa.diagram(athlete_3factor, digits = 2, simple = TRUE)

# 2 factor CFA
athlete_2model <- 'A =~ sprt_goals + cnsdr_ath + frnds_ath + sprt_impt + think_sprt
                  B =~ dprs_sprt + bad_sprt'

athlete_2CFA = cfa(athlete_2model, data = selected_features,
                   ordered = names(selected_features),
                   std.lv = TRUE)
summary(athlete_2CFA, fit.measures = TRUE)

# 3 factor CFA
athlete_3model <- 'social_identity =~ sprt_goals + cnsdr_ath + frnds_ath 
                   exclusive = ~ sprt_impt + think_sprt
                   negative_affectivity =~ dprs_sprt + bad_sprt
                   athletic_identity =~social_identity + exclusive + negative_affectivity '

athlete_3CFA = cfa(athlete_3model, data = athletic_identity_matrix,
                   ordered = names(athletic_identity_matrix),
                   std.lv = TRUE)
summary(athlete_3CFA, fit.measures = TRUE)


```
Reject the 2 factor model and 3 factor model fits the data well.

## Construct Reliability: Resilience
```{r}
resilience <- c("bounce", "strs_evnt", "strs_rcvr", "snap_back","difficult","setbacks")

total_resilience <- athletes[, resilience] %>% map_df(., as.numeric)
total_alpha <-  psych::alpha(positive_resilience %>% as.matrix())
positive_alpha

resilience_positive <- c("bounce", "strs_rcvr","difficult")

positive_resilience <- athletes[, resilience_positive] %>% map_df(., as.numeric)
positive_alpha <-  psych::alpha(positive_resilience %>% as.matrix())
positive_alpha

resilience_negative <- c("strs_evnt", "snap_back","setbacks")
negative_resilience <- athletes[, resilience_negative] %>% map_df(., as.numeric)
negative_alpha <-  psych::alpha(negative_resilience %>% as.matrix())
negative_alpha

# 2 factor CFA
resilience_2factor <-'positive = ~bounce + strs_rcvr + difficult
                      negative = ~strs_evnt + snap_back + setbacks'

resilience_2CFA = cfa(resilience_2factor, data = total_resilience,
                   ordered = names(total_resilience),
                   std.lv = TRUE)
summary(resilience_2CFA, fit.measures = TRUE)

# 1 factor CFA
resilience_1factor <- 'resilience=~ bounce + strs_evnt + strs_rcvr + snap_back + difficult + setbacks'

resilience_1CFA = cfa(resilience_1factor, data = total_resilience,
                   ordered = names(total_resilience),
                   std.lv = TRUE)
summary(resilience_1CFA, fit.measures = TRUE)
```

Chronbach's alpha is 0.89, with a 95 \% confidence interval of (0.87, 0.90).

## Construct Reliability: wellbeing (measured by The Adult Mental Health Continuum 14 items)
```{r}
#wellbeing <- c("happy", "strs_evnt", "strs_rcvr", "snap_back","difficult","setbacks")
selected_wellbeing <- athletes[, 28:41] %>% map_df(., as.numeric)
wellbeing_alpha <-  psych::alpha(selected_wellbeing %>% as.matrix())
wellbeing_alpha
```

Chronbach's alpha is 0.91, with a 95 \% confidence interval of (0.90, 0.91).

## Construct Reliability: Anxiety & Depression (measured by The hospital anxiety and depression scale 14 items)
```{r}
selected_AD <- athletes[, 42:55] %>% map_df(., as.numeric)
ad_alpha <-  psych::alpha(selected_AD %>% as.matrix())
ad_alpha
```

Chronbach's alpha is 0.88, with a 95 \% confidence interval of (0.86, 0.90).

## Construct Reliability: Loneliness (measured by The Short Loneliness Scale 6 items)
```{r}
selected_lonelinss <- athletes[, 62:67] %>% map_df(., as.numeric)
lonelinss_alpha <-  psych::alpha(selected_lonelinss %>% as.matrix())
lonelinss_alpha
```

Chronbach's alpha is 0.68, with a 95 \% confidence interval of (0.63, 0.73).
Drop miss_ppl to increase alpha to 0.76 (?)

## Latent Variables

LV1:dedication_to_sport
CNSDR_ATH: I consider myself an athlete
SPRT_GOALS: I have many goals related to sport
FRNDS_ATH: Most of my friends are athlete
SPRT_IMPT: Sport is the most important part of my life
THINK_SPRT: I spend more time thinking about sport than anything else
SPRT_LVL: Sport level

LV2:positive_outlook
HAPPY: Happy
INT_LIFE: Interested in life
SATISFIED: Satisfied
CONT_SOC: That you had something important to contribute to society

LV3:interaction_society
BELONG: That you belonged to a community (like a social group or neighbourhood)
BET_SOC: That our society is becoming a better place for people like you
PEOPLE_GOOD: That people are basically good
SENSE_SOC: That the way our society works makes sense to you

LV4: maturity
LIKE_PER: That you liked most parts of your personality
RESPONSIBLE: Good at managing the responsibilities of your daily life
WARM_REL: That you had warm and trusting relationships with others
CHAL_EXP: That you had experiences that challenged you to grow and become a better person
EXP_IDEA: Confident to think or express your own ideas and opinions
MEANING: That your life has a sense of direction or meaning to it

LV5: resilience
BOUNCE: I ten-d to bounce back quickly after hard times
STRS_EVNT: I have a hard time making it through stressful events
STRS_RCVR: It does not take me long to recover from a stressful event
SNAP_BACK: It is hard for me to snap back when something bad happens
DIFFICULT: I usually come through difficult times with little trouble
SETBACKS: I tend to take a long time to get over setbacks in my life

## factor diagram
```{r}
fa.diagram(mod_5,digits = 2,simple = TRUE, rsize = 2)

model_5 = "
dedication_to_sport = ~CNSDR_ATH + SPRT_GOALS + FRNDS_ATH + SPRT_IMPT + THINK_SPRT + SPRT_LVL
positive_outlook = ~ HAPPY + INT_LIFE + SATISFIED + CONT_SOC
interaction_society = ~ BELONG + BET_SOC + PEOPLE_GOOD + SENSE_SOC 
maturity = ~ LIKE_PER + RESPONSIBLE + WARM_REL +  CHAL_EXP + EXP_IDEA + MEANING
resilience = ~ BOUNCE + STRS_EVNT + STRS_RCVR + SNAP_BACK + DIFFICULT + SETBACKS
"
```

## CFA
```{r}
library(lavaan)
mod_5_cfa = cfa(model_5, data =features1,
                #ordered = names(features1),
                estimator = "WLSMV",
                std.lv=TRUE)

summary(mod_5_cfa, fit.measure= TRUE)
```

```{r}
 athlete_sem2 <- '
  # measurement model
    external_identity =~ sprt_goals + cnsdr_ath + frnds_ath
    internal_value =~ sprt_impt + think_sprt
    negative_events =~ dprs_sprt + bad_sprt
    
    athlete_identity =~ external_identity + internal_value + negative_events
    
    healthy_lifestyle =~ hr_sleep + smoking + fruit_veg
    
    resilience =~ bounce + strs_evnt + strs_rcvr + snap_back + difficult + setbacks
    
  # structural model - direct effects
    mhc_sf ~ a*athlete_identity + b*healthy_lifestyle + c*resilience
    resilience ~ d*athlete_identity
    healthy_lifestyle ~ e*athlete_identity

  # indirect
    indirect_athlete_identity := d*c + e*b

  # total
    total_athlete_identity:= d*c + a + e*b
'

athlete_sem_fit2 <- sem(athlete_sem2, 
                       data = dataset, 
                       sample.cov = TRUE, 
                       missing = "ML")
summary(athlete_sem_fit2)

semPaths(athlete_sem_fit2,
         what = "std",
         whatLabels = "std", 
         reorder = FALSE,
         layout = "tree2",
         intercepts = FALSE)
```







